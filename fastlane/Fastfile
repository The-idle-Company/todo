default_platform(:ios)

platform :ios do
  lane :upload_ipa_to_testflight_app_store_connect do
    # Use the decoded API key stored as a file
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_API_KEY"] # Path to the decoded .p8 key file
    )

    latest_build = latest_testflight_build_number(
      app_identifier: "com.test.todo.kehinde", # Replace with your bundle ID
      api_key: api_key,
      version: "1.0" # Provide a version
    )

    puts "Latest Build Number: #{latest_build}"

    # Additional steps for uploading IPA, etc.
    pilot(
      ipa: "/Users/runner/work/_temp/latest-Todo.ipa", 
      app_identifier: "com.test.todo.kehinde", 
      api_key: api_key, 
      skip_waiting_for_build_processing: true
    )
  end
end
