# Fastfile

require 'json'  # Require JSON library to parse the JSON file

default_platform(:ios)

platform :ios do
  desc "Upload IPA to TestFlight"
  lane :upload_ipa_to_testflight do
    # Read and parse the API key JSON
    api_key_path = "/Users/runner/work/_temp/api_key.json"
    api_key_contents = File.read(api_key_path)
    api_key_hash = JSON.parse(api_key_contents)

    # Create the correct API key format for App Store Connect API
    api_key = {
      key_id: api_key_hash["key_id"],
      issuer_id: api_key_hash["issuer_id"],
      key: api_key_hash["key"],
      is_key_content_base64: false
    }

    # Increment the build number before uploading
    increment_build_number(
      build_number: (latest_testflight_build_number(
        app_identifier: "com.test.todo.kehinde",
        api_key: api_key
      ) + 1)
    )

    # Upload the IPA to TestFlight
    pilot(
      ipa: "/Users/runner/work/_temp/latest-Todo.ipa",
      app_identifier: "com.test.todo.kehinde",
      api_key: api_key
    )
  end
end
