default_platform(:ios)

platform :ios do
  lane :upload_ipa_to_testflight_app_store_connect do
    # Fetch App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID'],
      key_content: File.read(ENV['APP_STORE_CONNECT_API_KEY'])
    )

    # Get the latest build number from TestFlight for the specific version
    begin
      latest_build = latest_testflight_build_number(
        app_identifier: "com.test.todo.kehinde",  # Replace with your app's identifier
        api_key: api_key
        # Remove `version` argument or verify that version "1.0" exists
      )
      
      UI.message("Latest build number: #{latest_build}")
    rescue => e
      UI.error("Error fetching the latest build number: #{e.message}")
      return  # Gracefully return from lane if there's an issue fetching the build number
    end

    # Increment the build number if needed
    new_build_number = latest_build + 1
    UI.message("New build number will be: #{new_build_number}")

    # Upload the IPA to TestFlight
    begin
      pilot(
        ipa: "/Users/runner/work/_temp/latest-Todo.ipa",  # Path to your IPA file
        app_identifier: "com.test.todo.kehinde",  # Replace with your app's identifier
        api_key: api_key,  # Pass the API key
        skip_waiting_for_build_processing: true  # Skip waiting for build processing in TestFlight
      )
      UI.success("IPA successfully uploaded to TestFlight")
    rescue => e
      UI.error("Error uploading IPA to TestFlight: #{e.message}")
      return  # Gracefully return from lane if upload fails
    end
  end
end
