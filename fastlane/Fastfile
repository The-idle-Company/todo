require 'json'

default_platform(:ios)

platform :ios do
  desc "Upload IPA to TestFlight"
  lane :upload_ipa_to_testflight do
    # Read and parse the JSON content into a Ruby hash
    api_key_path = "/Users/runner/work/_temp/api_key.json"
    api_key_contents = File.read(api_key_path)
    api_key = JSON.parse(api_key_contents)

    # Create the correct API key format
    app_store_connect_api_key = {
      key_id: api_key["key_id"],
      issuer_id: api_key["issuer_id"],
      key: api_key["key"],
      is_key_content_base64: false
    }

    # Increment the build number before uploading
    current_build_number = latest_testflight_build_number(
      app_identifier: "com.test.todo.kehinde",
      api_key: app_store_connect_api_key
    )

    # Increment the build number
    increment_build_number(
      build_number: current_build_number + 1
    )

    # Manually update CFBundleVersion in Info.plist
    sh("plutil -replace CFBundleVersion -string '#{current_build_number + 1}' ./ToDo/Info.plist")

    # Upload the IPA to TestFlight
    pilot(
      ipa: "/Users/runner/work/_temp/latest-Todo.ipa",
      app_identifier: "com.test.todo.kehinde",
      api_key: app_store_connect_api_key
    )
  end
end
